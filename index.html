<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>To do</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #1e3a8a;
            --surface-primary: #1e40af;
            --surface-secondary: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --border: #3b82f6;
            --shadow: rgba(59, 130, 246, 0.3);
            --overlay: rgba(0, 0, 0, 0.7);
            --accent: #60a5fa;
        }

        * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        ::selection {
            background-color: #ff8c00;
            color: #ffffff;
        }

        ::-moz-selection {
            background-color: #ff8c00;
            color: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            font-family: 'Comic Neue', cursive;
            user-select: none;
            gap: 2rem;
        }

        #display {
            font-size: 2.5rem;
            font-weight: bold;
            padding: 2rem;
            border-radius: 2rem;
            background: linear-gradient(145deg, var(--surface-primary), var(--surface-secondary));
            box-shadow: 0 20px 40px var(--shadow);
            cursor: pointer;
            color: var(--text-primary);
            text-align: center;
            width: calc(100vw - 4rem);
            max-width: 800px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            word-wrap: break-word;
            transition: all 0.3s ease;
            border: 2px solid var(--border);
            position: relative;
            gap: 1rem;
            margin: 2rem;
        }

        .card-text {
            font-size: 2.5rem;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }

        .card-button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 1rem;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-primary);
            background: linear-gradient(145deg, var(--accent), var(--surface-secondary));
            border: 2px solid var(--accent);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            min-width: 120px;
        }

        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--shadow);
            background: linear-gradient(145deg, var(--surface-secondary), var(--accent));
        }

        .card-button:active {
            transform: translateY(0);
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay);
            z-index: 1000;
        }

        .popup-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, var(--surface-primary), var(--surface-secondary));
            border-radius: 2rem;
            box-shadow: 0 20px 40px var(--shadow);
            border: 2px solid var(--border);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            font-family: 'Comic Neue', cursive;
            color: var(--text-primary);
        }

        .popup-window.expanded {
            max-width: 600px;
            width: 95%;
        }

        .popup-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--text-primary);
        }

        .setting-row {
            display: flex;
            flex-direction: column;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }

        .setting-label {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .setting-input {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 1rem;
            font-family: inherit;
            font-size: 1rem;
            background: var(--surface-primary);
            color: var(--text-primary);
            text-align: center;
            transition: all 0.3s ease;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--shadow);
        }

        .popup-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .popup-button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 1rem;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-primary);
            background: linear-gradient(145deg, var(--surface-secondary), var(--accent));
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--shadow);
        }

        .popup-button:active {
            transform: translateY(0);
        }

        .menu-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, var(--surface-primary), var(--surface-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 20px var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .menu-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px var(--shadow);
        }

        .menu-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
        }

        .profile-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 999;
            max-width: 200px;
        }

        .profile-item-header {
            color: var(--text-primary);
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.3rem 0.8rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease;
            background: none;
            border: none;
            box-shadow: none;
        }

        .profile-item-header:hover {
            color: var(--accent);
        }

        .profile-item-header.active {
            color: var(--accent);
            text-shadow: 0 0 10px var(--shadow);
        }

        .settings-content {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 1rem;
            position: relative;
        }

        .settings-content::-webkit-scrollbar {
            width: 12px;
        }

        .settings-content::-webkit-scrollbar-track {
            background: var(--surface-primary);
            border-radius: 6px;
        }

        .settings-content::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 6px;
        }

        .settings-content::-webkit-scrollbar-thumb:hover {
            background: var(--surface-secondary);
        }

        .data-section, .profiles-section {
            margin-top: 2rem;
        }

        .profile-item, .data-item {
            background: var(--surface-primary);
            border: 2px solid var(--border);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .data-item {
            flex-direction: column;
            align-items: stretch;
        }

        .profile-item.active, .data-item.active {
            border-color: var(--accent);
            background: rgba(96, 165, 250, 0.1);
        }

        .profile-item:hover, .data-item:hover {
            border-color: var(--accent);
            background: rgba(96, 165, 250, 0.05);
        }

        .profile-item.dragging, .data-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .profile-item.drag-over, .data-item.drag-over {
            border-color: var(--accent);
            background: rgba(96, 165, 250, 0.1);
        }

        .profile-name, .data-item-text {
            flex: 1;
            color: var(--text-primary);
            font-weight: bold;
            word-break: break-word;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .data-item-text {
            cursor: pointer;
        }

        .data-item-text:hover {
            background: rgba(96, 165, 250, 0.1);
        }

        .profile-name-input, .data-item-text-input, .data-item-url-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--accent);
            border-radius: 0.5rem;
            background: var(--surface-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-weight: bold;
            font-size: inherit;
            outline: none;
            box-sizing: border-box;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .data-item-url-input {
            font-size: 0.9rem;
            padding: 0.3rem 0.5rem;
            border-radius: 0.3rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-align: center;
        }

        .drag-delete-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drag-delete-hint.show {
            opacity: 1;
        }

        .drag-handle {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .drag-handle:hover {
            opacity: 1;
            color: var(--accent);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .data-item-url {
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 0.3rem;
            transition: all 0.3s ease;
        }

        .data-item-url:hover {
            background: rgba(96, 165, 250, 0.1);
        }

        .weight-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .weight-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-width: 60px;
        }

        .inline-weight-slider {
            flex: 1;
            height: 4px;
            background: var(--surface-secondary);
            border-radius: 2px;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .inline-weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .inline-weight-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .weight-display {
            min-width: 25px;
            text-align: center;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .add-item-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 1rem;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .add-item-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(96, 165, 250, 0.1);
        }

        .url-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .url-input-container .setting-input {
            flex: 1;
        }

        .sync-icon {
            width: auto;
            height: 54px;
            padding: 0 1rem;
            background: linear-gradient(145deg, var(--surface-secondary), var(--accent));
            border: 2px solid var(--border);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .sync-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--shadow);
        }

        .sync-icon:active {
            transform: translateY(0);
        }

        .sync-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }

        .sync-icon.syncing svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body { padding: 0 0.5rem; box-sizing: border-box; }
            #display { font-size: 1.8rem; padding: 1.5rem; margin: 2rem; width: calc(100vw - 4rem); min-height: 150px; }
            .card-text { font-size: 1.8rem; }
            .card-button { font-size: 1rem; padding: 0.8rem 1.5rem; min-width: 100px; }
            .popup-window { width: calc(100vw - 2rem); padding: 1.5rem; margin: 1rem; left: 1rem; right: 1rem; transform: translateY(-50%); max-height: calc(100vh - 2rem); overflow: hidden; box-sizing: border-box; }
            .popup-window.expanded { max-width: none; width: calc(100vw - 2rem); max-height: calc(100vh - 2rem); }
            .settings-content { max-height: calc(100vh - 8rem); overflow-y: auto; padding-right: 0.5rem; margin-right: -0.5rem; }
            .settings-content::-webkit-scrollbar { width: 8px; }
            .popup-title { font-size: 1.5rem; }
            .profile-item { padding: 0.8rem; margin-bottom: 0.8rem; gap: 0.8rem; }
            .profile-name { font-size: 0.9rem; padding: 0.4rem; }
            .data-item { padding: 0.8rem; margin-bottom: 0.8rem; }
            .drag-handle { width: 20px; height: 20px; top: 0.3rem; right: 0.3rem; }
            .drag-handle svg { width: 14px; height: 14px; }
            .data-item-text { padding: 0.4rem; font-size: 0.9rem; }
            .data-item-url { font-size: 0.8rem; padding: 0.2rem 0.4rem; }
            .weight-control { gap: 0.8rem; }
            .weight-label { font-size: 0.8rem; min-width: 50px; }
            .menu-icon { width: 40px; height: 40px; top: 15px; left: 15px; z-index: 1001; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
            .menu-icon svg { width: 20px; height: 20px; }
            .profile-selector { top: 15px; right: 15px; max-width: 150px; }
            .profile-item-header { padding: 0.2rem 0.6rem; font-size: 0.8rem; }
            .setting-input { padding: 0.8rem; font-size: 0.9rem; }
            .sync-icon { height: 44px; padding: 0 0.8rem; }
            .sync-icon svg { width: 16px; height: 16px; }
            .drag-delete-hint { bottom: 15px; font-size: 0.7rem; padding: 0.4rem 0.8rem; }
        }

        @media (max-width: 480px) {
            body { padding: 0 0.5rem; box-sizing: border-box; }
            #display { font-size: 1.5rem; padding: 1rem; margin: 1.5rem; width: calc(100vw - 3rem); }
            .card-text { font-size: 1.5rem; }
            .popup-window { padding: 1rem; width: calc(100vw - 1rem); margin: 0.5rem; left: 0.5rem; right: 0.5rem; transform: translateY(-50%); max-height: calc(100vh - 1rem); }
            .settings-content { max-height: calc(100vh - 6rem); padding-right: 0.25rem; margin-right: -0.25rem; }
            .popup-title { font-size: 1.3rem; }
        }

        @media (max-width: 320px) {
            body { padding: 0 0.25rem; }
            #display { margin: 1.25rem; width: calc(100vw - 2.5rem); padding: 0.8rem; }
            .popup-window { width: calc(100vw - 0.5rem); margin: 0.25rem; left: 0.25rem; right: 0.25rem; padding: 0.8rem; max-height: calc(100vh - 0.5rem); }
            .settings-content { max-height: calc(100vh - 5rem); padding-right: 0; margin-right: 0; }
        }
    </style>
</head>

<body>
    <div class="menu-icon" onclick="app.openSettings()">
        <svg viewBox="0 0 24 24">
            <path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
        </svg>
    </div>

    <div id="profileSelector" class="profile-selector"></div>
    <div id="display">
        <div class="card-text"></div>
    </div>

    <div id="deleteHint" class="drag-delete-hint">🗑️ Drop here to delete</div>

    <div id="settingsPopup" class="popup-overlay">
        <div class="popup-window expanded">
            <div class="settings-content">
                <div class="popup-title">Settings</div>

                <div class="profiles-section">
                    <div class="section-title">Profiles</div>
                    <div id="profilesList"></div>
                    <button class="add-item-btn" onclick="app.addNewProfile()">+ Add New Profile</button>
                </div>

                <div class="data-section">
                    <div class="section-title">Data Items</div>
                    <div id="dataItemsList"></div>
                    <button class="add-item-btn" onclick="app.addNewItem()">+ Add New Item</button>
                </div>

                <div class="setting-row" style="margin-top: 2rem; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4;">
                        💡 Double-click to edit 🧩 Drag to reorder or delete
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-label">Server URL</div>
                    <div class="url-input-container">
                        <input type="url" id="urlInput" class="setting-input">
                        <div class="sync-icon" onclick="app.syncFromServer()" title="Sync from server">
                            <svg viewBox="0 0 24 24">
                                <path d="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="setting-row" style="margin-top: 2rem;">
                    <div class="setting-label">Password</div>
                    <input type="password" id="passwordInput" class="setting-input">
                </div>

                <div class="popup-buttons">
                    <button class="popup-button" onclick="app.cancelSettings()">Cancel</button>
                    <button class="popup-button" onclick="app.saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BoredApp {
            constructor() {
                this.weightedOptions = [];
                this.localData = [];
                this.profilesData = [];
                this.currentProfileIndex = 0;
                this.displayElem = document.getElementById('display');
                this.currentUrl = '';
                this.currentPassword = '';
                this.isPopupOpen = false;
                this.lastSelectedOption = null;
                this.lastSyncedUrl = '';
                this.dragState = new DragState();
                this.init();
            }

            init() {
                const savedUrl = localStorage.getItem('bored.url');
                const savedPassword = localStorage.getItem('bored.password');
                const savedProfileIndex = localStorage.getItem('bored.currentProfileIndex');
                
                if (savedUrl) this.currentUrl = savedUrl;
                if (savedPassword) this.currentPassword = savedPassword;
                if (savedProfileIndex) this.currentProfileIndex = parseInt(savedProfileIndex) || 0;

                this.loadData().catch(() => this.openSettings());
                this.updateProfileSelector();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === '`' || e.keyCode === 192) {
                        e.preventDefault();
                        this.isPopupOpen ? this.closeSettings() : this.openSettings();
                    }
                });

                const hasTouchSupport = 'ontouchstart' in window;
                
                if (hasTouchSupport) {
                    this.setupTouchEvents();
                    document.addEventListener('touchstart', (e) => {
                        if (!e.target.closest('.menu-icon') && !this.isPopupOpen) {
                            this.updateDisplay();
                        }
                    }, { passive: false });
                } else {
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.menu-icon') && !this.isPopupOpen) {
                            this.updateDisplay();
                        }
                    });
                }
            }

            setupTouchEvents() {
                const menuIcon = document.querySelector('.menu-icon');
                if (menuIcon) {
                    let touchStartTime = 0;
                    let touchMoved = false;

                    menuIcon.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        touchMoved = false;
                    }, { passive: true });

                    menuIcon.addEventListener('touchmove', () => {
                        touchMoved = true;
                    }, { passive: true });

                    menuIcon.addEventListener('touchend', (e) => {
                        const touchDuration = Date.now() - touchStartTime;
                        if (!touchMoved && touchDuration < 500) {
                            e.preventDefault();
                            e.stopPropagation();
                            this.openSettings();
                        }
                    }, { passive: false });
                }
            }

            updateDisplay() {
                if (!this.weightedOptions || this.weightedOptions.length === 0) {
                    this.displayElem.innerHTML = '<div class="card-text">No data available</div>';
                    return;
                }

                let selectedOption = this.selectRandomOption();
                this.lastSelectedOption = selectedOption;
                this.displayCard(selectedOption);
            }

            selectRandomOption() {
                let availableOptions = this.weightedOptions;

                if (this.weightedOptions.length >= 2 && this.lastSelectedOption) {
                    availableOptions = this.weightedOptions.filter(option => option !== this.lastSelectedOption);
                    if (availableOptions.length === 0) {
                        availableOptions = this.weightedOptions;
                    }
                }

                const totalWeight = availableOptions.reduce((sum, option) => sum + option.weight, 0);
                const random = Math.random() * totalWeight;
                
                let currentWeight = 0;
                for (const option of availableOptions) {
                    currentWeight += option.weight;
                    if (random <= currentWeight) {
                        return option;
                    }
                }

                return availableOptions[availableOptions.length - 1];
            }

            displayCard(option) {
                let cardHTML = `<div class="card-text">${option.text}</div>`;

                if (option.url) {
                    let displayUrl = option.url.replace(/^https?:\/\//, '');
                    cardHTML += `<a href="${option.url}" target="_blank" class="card-button" onclick="event.stopPropagation()">${displayUrl}</a>`;
                }

                this.displayElem.innerHTML = cardHTML;
            }

            async loadData() {
                const dataUrl = this.currentUrl || 'default.json';
                const savedData = localStorage.getItem('bored.localProfiles');
               const savedUrl = localStorage.getItem('bored.url');

               if (savedData && savedUrl === this.currentUrl && this.currentUrl) {
                   try {
                       this.profilesData = JSON.parse(savedData);
                       this.processProfileData();
                       this.updateProfileSelector();
                       this.updateDisplay();
                       return;
                   } catch (e) {
                       // Continue to fetch from URL
                   }
               }

               const response = await fetch(dataUrl);
               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }

               const data = await response.json();
               
               if (Array.isArray(data) && data.length > 0 && data[0].name && data[0].items) {
                   this.profilesData = data;
               } else if (Array.isArray(data)) {
                   this.profilesData = [{
                       name: "Default",
                       items: data.map(item => ({
                           text: item.text || '',
                           weight: item.weight || 1,
                           url: item.url || ''
                       }))
                   }];
               } else {
                   throw new Error('Data must be an array of profiles or items');
               }

               if (this.currentProfileIndex >= this.profilesData.length) {
                   this.currentProfileIndex = 0;
               }

               if (this.currentUrl) {
                   localStorage.setItem('bored.localProfiles', JSON.stringify(this.profilesData));
               }

               this.processProfileData();
               this.updateProfileSelector();
               this.updateDisplay();
           }

           processProfileData() {
               if (this.profilesData.length === 0) {
                   this.localData = [];
                   this.weightedOptions = [];
                   return;
               }

               const currentProfile = this.profilesData[this.currentProfileIndex] || this.profilesData[0];
               this.localData = currentProfile.items || [];

               this.weightedOptions = this.localData
                   .filter(item => item.text && (item.weight || 1) > 0)
                   .map(item => ({
                       text: item.text,
                       weight: item.weight || 1,
                       url: item.url || null
                   }));
           }

           openSettings() {
               this.isPopupOpen = true;
               document.getElementById('urlInput').value = this.currentUrl || '';
               document.getElementById('passwordInput').value = this.currentPassword || '';
               this.lastSyncedUrl = this.currentUrl || '';
               
               this.populateProfilesList();
               this.populateDataItemsList();
               document.getElementById('settingsPopup').style.display = 'block';
           }

           closeSettings() {
               this.isPopupOpen = false;
               document.getElementById('settingsPopup').style.display = 'none';
           }

           populateProfilesList() {
               const listContainer = document.getElementById('profilesList');
               listContainer.innerHTML = '';

               this.profilesData.forEach((profile, index) => {
                   const profileDiv = this.createProfileItem(profile, index);
                   listContainer.appendChild(profileDiv);
               });
           }

           createProfileItem(profile, index) {
               const profileDiv = document.createElement('div');
               profileDiv.className = 'profile-item';
               profileDiv.dataset.index = index;
               if (index === this.currentProfileIndex) {
                   profileDiv.classList.add('active');
               }

               const dragHandle = this.createDragHandle();
               this.setupDragHandleEvents(profileDiv, dragHandle);

               const nameDiv = document.createElement('div');
               nameDiv.className = 'profile-name';
               nameDiv.textContent = profile.name || `Profile ${index + 1}`;
               nameDiv.addEventListener('dblclick', () => this.editProfileName(nameDiv, index));

               profileDiv.addEventListener('click', (e) => {
                   if (e.detail === 1) {
                       setTimeout(() => {
                           if (!profileDiv.classList.contains('dragging')) {
                               this.selectProfile(index);
                           }
                       }, 200);
                   }
               });

               this.dragState.setupDragEvents(profileDiv, 'profile');

               profileDiv.appendChild(dragHandle);
               profileDiv.appendChild(nameDiv);
               return profileDiv;
           }

           populateDataItemsList() {
               const listContainer = document.getElementById('dataItemsList');
               listContainer.innerHTML = '';

               this.localData.forEach((item, index) => {
                   const itemDiv = this.createDataItem(item, index);
                   listContainer.appendChild(itemDiv);
               });
           }

           createDataItem(item, index) {
               const itemDiv = document.createElement('div');
               itemDiv.className = 'data-item';
               itemDiv.dataset.index = index;

               const dragHandle = this.createDragHandle();
               this.setupDragHandleEvents(itemDiv, dragHandle);

               const textDiv = this.createEditableElement('data-item-text', item.text || 'Empty text', 
                   () => this.editText(textDiv, index));

               const urlDiv = this.createEditableElement('data-item-url', item.url || ' ', 
                   () => this.editUrl(urlDiv, index));

               const weightDiv = this.createWeightControl(item, index, itemDiv);

               this.dragState.setupDragEvents(itemDiv, 'data');

               itemDiv.appendChild(dragHandle);
               itemDiv.appendChild(textDiv);
               itemDiv.appendChild(urlDiv);
               itemDiv.appendChild(weightDiv);
               return itemDiv;
           }

           createDragHandle() {
               const dragHandle = document.createElement('div');
               dragHandle.className = 'drag-handle';
               dragHandle.innerHTML = `
                   <svg viewBox="0 0 24 24">
                       <path d="M7,19V17H9V19H7M11,19V17H13V19H11M15,19V17H17V19H15M7,15V13H9V15H7M11,15V13H13V15H11M15,15V13H17V15H15M7,11V9H9V11H7M11,11V9H13V11H11M15,11V9H17V11H15M7,7V5H9V7H7M11,7V5H13V7H11M15,7V5H17V7H15Z"/>
                   </svg>
               `;
               return dragHandle;
           }

           setupDragHandleEvents(element, dragHandle) {
               element.draggable = false;
               dragHandle.addEventListener('mousedown', () => {
                   element.draggable = true;
               });
               element.addEventListener('mouseup', () => {
                   element.draggable = false;
               });
               element.addEventListener('mouseleave', () => {
                   element.draggable = false;
               });
           }

           createEditableElement(className, text, onEdit) {
               const element = document.createElement('div');
               element.className = className;
               element.textContent = text;
               element.addEventListener('dblclick', onEdit);
               return element;
           }

           createWeightControl(item, index, itemDiv) {
               const weightDiv = document.createElement('div');
               weightDiv.className = 'weight-control';

               const weightLabel = document.createElement('span');
               weightLabel.className = 'weight-label';
               weightLabel.textContent = 'Weight:';

               const weightSlider = document.createElement('input');
               weightSlider.type = 'range';
               weightSlider.min = '1';
               weightSlider.max = '10';
               weightSlider.value = item.weight || 1;
               weightSlider.className = 'inline-weight-slider';

               const weightDisplay = document.createElement('span');
               weightDisplay.className = 'weight-display';
               weightDisplay.textContent = item.weight || 1;

               weightSlider.addEventListener('input', () => {
                   const currentIndex = parseInt(itemDiv.dataset.index);
                   weightDisplay.textContent = weightSlider.value;
                   this.localData[currentIndex].weight = parseInt(weightSlider.value);
               });

               weightDiv.appendChild(weightLabel);
               weightDiv.appendChild(weightSlider);
               weightDiv.appendChild(weightDisplay);
               return weightDiv;
           }

           selectProfile(index) {
               if (index >= 0 && index < this.profilesData.length) {
                   this.currentProfileIndex = index;
                   localStorage.setItem('bored.currentProfileIndex', this.currentProfileIndex.toString());
                   this.processProfileData();
                   this.populateProfilesList();
                   this.populateDataItemsList();
                   this.updateProfileSelector();
                   this.updateDisplay();
               }
           }

           editProfileName(nameDiv, index) {
               this.editInPlace(nameDiv, 'profile-name-input', 
                   this.profilesData[index].name || '', 
                   (newText) => {
                       if (newText === '' && this.profilesData.length > 1 && 
                           confirm('Delete this profile?')) {
                           this.deleteProfile(index);
                       } else if (newText !== '') {
                           this.profilesData[index].name = newText;
                           nameDiv.textContent = newText;
                       }
                   });
           }

           editText(textDiv, originalIndex) {
               const itemDiv = textDiv.closest('.data-item');
               const currentIndex = parseInt(itemDiv.dataset.index);
               const currentText = this.localData[currentIndex].text || '';

               this.editInPlace(textDiv, 'data-item-text-input', currentText, 
                   (newText) => {
                       if (newText === '' && confirm('Delete this item?')) {
                           this.localData.splice(currentIndex, 1);
                           this.populateDataItemsList();
                       } else if (newText !== '') {
                           this.localData[currentIndex].text = newText;
                           textDiv.textContent = newText;
                       }
                   },
                   (e) => {
                       if (e.key === 'Tab') {
                           e.preventDefault();
                           setTimeout(() => {
                               const urlDiv = textDiv.parentNode.querySelector('.data-item-url');
                               if (urlDiv) urlDiv.dispatchEvent(new Event('dblclick'));
                           }, 100);
                       }
                   });
           }

           editUrl(urlDiv, originalIndex) {
               const itemDiv = urlDiv.closest('.data-item');
               const currentIndex = parseInt(itemDiv.dataset.index);
               const currentUrl = this.localData[currentIndex].url || '';

               this.editInPlace(urlDiv, 'data-item-url-input', currentUrl, 
                   (newUrl) => {
                       this.localData[currentIndex].url = newUrl.trim();
                       urlDiv.textContent = newUrl.trim();
                   });
           }

           editInPlace(element, inputClass, initialValue, onSave, onKeyDown = null) {
               const input = document.createElement('input');
               input.type = inputClass.includes('url') ? 'url' : 'text';
               input.value = initialValue;
               input.className = inputClass;

               let isSaved = false;

               const save = () => {
                   if (isSaved) return;
                   isSaved = true;
                   onSave(input.value.trim());
                   element.style.display = 'block';
                   if (input.parentNode) input.remove();
               };

               input.addEventListener('blur', save);
               input.addEventListener('keydown', (e) => {
                   if (e.key === 'Enter') {
                       save();
                   } else if (onKeyDown) {
                       onKeyDown(e);
                   }
               });

               element.style.display = 'none';
               element.parentNode.insertBefore(input, element);
               input.focus();
               input.select();
           }

           deleteProfile(index) {
               this.profilesData.splice(index, 1);
               if (this.currentProfileIndex >= this.profilesData.length) {
                   this.currentProfileIndex = this.profilesData.length - 1;
               } else if (this.currentProfileIndex > index) {
                   this.currentProfileIndex--;
               }
               localStorage.setItem('bored.currentProfileIndex', this.currentProfileIndex.toString());
               this.processProfileData();
               this.populateProfilesList();
               this.populateDataItemsList();
               this.updateProfileSelector();
           }

           addNewProfile() {
               const newProfile = {
                   name: `Profile ${this.profilesData.length + 1}`,
                   items: []
               };
               this.profilesData.push(newProfile);
               this.populateProfilesList();
               this.updateProfileSelector();

               setTimeout(() => {
                   const profileNames = document.querySelectorAll('.profile-name');
                   if (profileNames.length > 0) {
                       profileNames[profileNames.length - 1].dispatchEvent(new Event('dblclick'));
                   }
               }, 100);
           }

           addNewItem() {
               const newItem = { text: 'New item', url: '', weight: 1 };
               this.localData.push(newItem);
               this.populateDataItemsList();

               setTimeout(() => {
                   const dataItems = document.querySelectorAll('.data-item-text');
                   if (dataItems.length > 0) {
                       dataItems[dataItems.length - 1].dispatchEvent(new Event('dblclick'));
                   }
               }, 100);
           }

           updateProfileSelector() {
               const selectorContainer = document.getElementById('profileSelector');
               selectorContainer.innerHTML = '';

               this.profilesData.forEach((profile, index) => {
                   const profileButton = document.createElement('div');
                   profileButton.className = 'profile-item-header';
                   profileButton.textContent = profile.name || `Profile ${index + 1}`;

                   if (index === this.currentProfileIndex) {
                       profileButton.classList.add('active');
                   }

                   profileButton.addEventListener('click', () => this.selectProfile(index));
                   selectorContainer.appendChild(profileButton);
               });
           }

           syncFromServer(showSpinner = true) {
               const urlFromInput = document.getElementById('urlInput').value.trim();
               const urlToSync = urlFromInput || this.currentUrl;

               if (!urlToSync) {
                   alert('Please enter a server URL first');
                   return;
               }

               if (showSpinner) {
                   this.lastSyncedUrl = urlFromInput || this.currentUrl;
               }

               const syncIcon = document.querySelector('.sync-icon');
               if (showSpinner && syncIcon) {
                   syncIcon.classList.add('syncing');
               }

               fetch(urlToSync)
                   .then(response => {
                       if (!response.ok) {
                           throw new Error(`HTTP error! status: ${response.status}`);
                       }
                       return response.json();
                   })
                   .then(data => {
                       if (Array.isArray(data) && data.length > 0 && data[0].name && data[0].items) {
                           this.profilesData = data;
                       } else if (Array.isArray(data)) {
                           this.profilesData = [{
                               name: "Default",
                               items: data.map(item => ({
                                   text: item.text || '',
                                   weight: item.weight || 1,
                                   url: item.url || ''
                               }))
                           }];
                       } else {
                           throw new Error('Data must be an array of profiles or items');
                       }

                       this.currentProfileIndex = 0;
                       localStorage.setItem('bored.currentProfileIndex', this.currentProfileIndex.toString());
                       localStorage.setItem('bored.localProfiles', JSON.stringify(this.profilesData));

                       this.processProfileData();
                       this.populateProfilesList();
                       this.populateDataItemsList();
                       this.updateProfileSelector();
                       this.updateDisplay();
                   })
                   .catch(error => {
                       alert('Failed to sync data from server: ' + error.message);
                   })
                   .finally(() => {
                       if (showSpinner && syncIcon) {
                           syncIcon.classList.remove('syncing');
                       }
                   });
           }

           async postDataToUrl() {
               if (!this.currentUrl || !this.currentPassword) {
                   return;
               }

               const url = new URL(this.currentUrl);
               const pathSegments = url.pathname.split('/').filter(segment => segment);
               const key = pathSegments[pathSegments.length - 1].replace('.json', '');
               const parentPath = pathSegments.slice(0, -1).join('/');
               const postUrl = url.origin + (parentPath ? '/' + parentPath : '');

               if (this.profilesData.length > 0 && this.currentProfileIndex < this.profilesData.length) {
                   this.profilesData[this.currentProfileIndex].items = [...this.localData];
               }

               const payload = {
                   key: key,
                   value: this.profilesData,
                   pswd: this.currentPassword
               };

               const response = await fetch(postUrl, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(payload)
               });

               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }

               const contentType = response.headers.get('content-type');
               if (contentType && contentType.includes('application/json')) {
                   return response.json();
               } else {
                   const text = await response.text();
                   if (text.toLowerCase().includes('ok') || text.trim() === '') {
                       return { success: true, message: text };
                   } else {
                       throw new Error(`Unexpected response: ${text}`);
                   }
               }
           }

           cancelSettings() {
               this.closeSettings();
           }

           saveSettings() {
               const newUrl = document.getElementById('urlInput').value.trim();
               const newPassword = document.getElementById('passwordInput').value.trim();

               this.updateLocalDisplay();
               this.currentPassword = newPassword;
               localStorage.setItem('bored.password', this.currentPassword);

               if (newUrl !== this.lastSyncedUrl && newUrl !== '') {
                   if (confirm('Server URL has changed since last sync. Do you want to sync data from the new server?')) {
                       this.currentUrl = newUrl;
                       localStorage.setItem('bored.url', this.currentUrl);
                       this.lastSyncedUrl = newUrl;
                       this.closeSettings();
                       this.syncFromServer(false);
                       return;
                   } else {
                       return;
                   }
               }

               if (newUrl !== this.currentUrl) {
                   this.currentUrl = newUrl;
                   if (newUrl) {
                       localStorage.setItem('bored.url', this.currentUrl);
                   } else {
                       localStorage.removeItem('bored.url');
                   }
               }

               if (this.currentUrl) {
                   localStorage.setItem('bored.localProfiles', JSON.stringify(this.profilesData));
               }

               this.closeSettings();

               if (this.currentUrl && this.currentPassword) {
                   this.postDataToUrl().catch(error => {
                       alert('Failed to save data to server: ' + error.message);
                   });
               }
           }

           updateLocalDisplay() {
               if (this.profilesData.length > 0 && this.currentProfileIndex < this.profilesData.length) {
                   this.profilesData[this.currentProfileIndex].items = [...this.localData];
               }
               this.processProfileData();
               this.updateDisplay();
           }
       }

       class DragState {
           constructor() {
               this.draggedElement = null;
               this.draggedIndex = null;
               this.draggedType = null;
               this.isOverSourceList = false;
               this.isOverDeleteZone = false;
           }

           setupDragEvents(element, type) {
               element.addEventListener('dragstart', (e) => this.handleDragStart(e, type));
               element.addEventListener('dragover', this.handleDragOver);
               element.addEventListener('drop', (e) => this.handleDrop(e, type));
               element.addEventListener('dragend', (e) => this.handleDragEnd(e, type));
               element.addEventListener('dragenter', this.handleDragEnter);
               element.addEventListener('dragleave', this.handleDragLeave);
           }

           handleDragStart(e, type) {
               this.draggedElement = e.target;
               this.draggedIndex = parseInt(e.target.dataset.index);
               this.draggedType = type;
               e.target.classList.add('dragging');

               e.dataTransfer.effectAllowed = 'move';
               e.dataTransfer.setData('text/html', e.target.outerHTML);

               document.addEventListener('dragover', this.handleDocumentDragOver.bind(this));
               document.addEventListener('dragenter', this.handleDocumentDragEnter.bind(this));
               document.addEventListener('dragleave', this.handleDocumentDragLeave.bind(this));

               document.getElementById('deleteHint').classList.add('show');
               this.isOverSourceList = true;
           }

           handleDragOver(e) {
               e.preventDefault();
               e.dataTransfer.dropEffect = 'move';
           }

           handleDragEnter(e) {
               if (e.target !== this.draggedElement) {
                   e.target.classList.add('drag-over');
               }
               this.isOverSourceList = true;
           }

           handleDragLeave(e) {
               e.target.classList.remove('drag-over');
               const sourceList = this.draggedType === 'profile' 
                   ? document.getElementById('profilesList')
                   : document.getElementById('dataItemsList');
               const rect = sourceList.getBoundingClientRect();
               const { clientX: x, clientY: y } = e;

               if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                   this.isOverSourceList = false;
               }
           }

           handleDrop(e, type) {
               e.stopPropagation();

               if (this.draggedElement !== e.target) {
                   const targetIndex = parseInt(e.target.dataset.index);
                   
                   if (type === 'profile') {
                       this.reorderProfiles(targetIndex);
                   } else if (type === 'data') {
                       this.reorderDataItems(targetIndex);
                   }
               }
           }

           reorderProfiles(targetIndex) {
               const draggedProfile = app.profilesData[this.draggedIndex];
               app.profilesData.splice(this.draggedIndex, 1);

               if (this.draggedIndex < targetIndex) {
                   app.profilesData.splice(targetIndex - 1, 0, draggedProfile);
                   if (app.currentProfileIndex === this.draggedIndex) {
                       app.currentProfileIndex = targetIndex - 1;
                   } else if (app.currentProfileIndex > this.draggedIndex && app.currentProfileIndex <= targetIndex) {
                       app.currentProfileIndex--;
                   }
               } else {
                   app.profilesData.splice(targetIndex, 0, draggedProfile);
                   if (app.currentProfileIndex === this.draggedIndex) {
                       app.currentProfileIndex = targetIndex;
                   } else if (app.currentProfileIndex >= targetIndex && app.currentProfileIndex < this.draggedIndex) {
                       app.currentProfileIndex++;
                   }
               }

               localStorage.setItem('bored.currentProfileIndex', app.currentProfileIndex.toString());
               app.populateProfilesList();
           }

           reorderDataItems(targetIndex) {
               const draggedItem = app.localData[this.draggedIndex];
               app.localData.splice(this.draggedIndex, 1);
               app.localData.splice(targetIndex, 0, draggedItem);
               app.populateDataItemsList();
           }

           handleDragEnd(e, type) {
               e.target.classList.remove('dragging');

               const allItems = document.querySelectorAll(type === 'profile' ? '.profile-item' : '.data-item');
               allItems.forEach(item => item.classList.remove('dragging', 'drag-over'));

               document.removeEventListener('dragover', this.handleDocumentDragOver);
               document.removeEventListener('dragenter', this.handleDocumentDragEnter);
               document.removeEventListener('dragleave', this.handleDocumentDragLeave);

               document.getElementById('deleteHint').classList.remove('show');

               if (this.isOverDeleteZone) {
                   this.handleDelete(type);
               }

               this.reset();
           }

           handleDelete(type) {
               if (type === 'profile' && app.profilesData.length > 1) {
                   const profileName = app.profilesData[this.draggedIndex].name || `Profile ${this.draggedIndex + 1}`;
                   if (confirm(`Delete profile "${profileName}"?`)) {
                       app.deleteProfile(this.draggedIndex);
                   }
               } else if (type === 'data') {
                   const itemText = app.localData[this.draggedIndex].text || 'this item';
                   if (confirm(`Delete "${itemText}"?`)) {
                       app.localData.splice(this.draggedIndex, 1);
                       app.populateDataItemsList();
                   }
               }
           }

           handleDocumentDragOver(e) {
               e.preventDefault();
               const deleteHint = document.getElementById('deleteHint');
               const rect = deleteHint.getBoundingClientRect();
               const { clientX: x, clientY: y } = e;

               const wasOverDeleteZone = this.isOverDeleteZone;
               this.isOverDeleteZone = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);

               const sourceList = this.draggedType === 'profile' 
                   ? document.getElementById('profilesList')
                   : document.getElementById('dataItemsList');
               const sourceRect = sourceList.getBoundingClientRect();

               const wasOverSourceList = this.isOverSourceList;
               this.isOverSourceList = (x >= sourceRect.left && x <= sourceRect.right &&
                   y >= sourceRect.top && y <= sourceRect.bottom);

               if (wasOverDeleteZone !== this.isOverDeleteZone || wasOverSourceList !== this.isOverSourceList) {
                   if (this.isOverDeleteZone) {
                       deleteHint.style.backgroundColor = 'rgba(220, 38, 38, 1)';
                   } else if (this.isOverSourceList) {
                       deleteHint.classList.remove('show');
                   } else {
                       deleteHint.classList.add('show');
                       deleteHint.style.backgroundColor = 'rgba(220, 38, 38, 0.9)';
                   }
               }
           }

           handleDocumentDragEnter(e) {
               const deleteHint = document.getElementById('deleteHint');
               const rect = deleteHint.getBoundingClientRect();
               const { clientX: x, clientY: y } = e;
               this.isOverDeleteZone = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
           }

           handleDocumentDragLeave(e) {
               const deleteHint = document.getElementById('deleteHint');
               const rect = deleteHint.getBoundingClientRect();
               const { clientX: x, clientY: y } = e;
               if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                   this.isOverDeleteZone = false;
               }
           }

           reset() {
               this.draggedElement = null;
               this.draggedIndex = null;
               this.draggedType = null;
               this.isOverSourceList = false;
               this.isOverDeleteZone = false;
           }
       }

       let app;

       document.addEventListener('DOMContentLoaded', () => {
           app = new BoredApp();
       });

       if (document.readyState !== 'loading') {
           app = new BoredApp();
       }
   </script>
</body>

</html>